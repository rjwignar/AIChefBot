
## Installation

This document gives an overview of how to install a working version of AIChefBot to a local repository, as well as detailing the deployment process to [Vercel](https://vercel.com/).

### Contents
- [Local Install](#installation)
- [Environment Variables](#Environment-Variables)
- [Deployment](#Deployment)

<hr>

### Installation

Set up a local development repository, clone the source repository via SSH.

```bash 
$ git clone git@github.com:rjwignar/AIChefBot.git
```

Navigate to the source directory.

```bash
$ cd AIChefBot
```

Install packages using NPM (this may take a minute).
```
$ npm install
```

### Environment Variables

Before a working version of AIChefBot can be run in a local repository, one must acquire and set environment variables.

```touch .env```

See an example of the `.env` file [here](./.env_example)

### Getting your keys

#### 1. OpenAI

[Sign up to OpenAI](https://platform.openai.com/signup)

- From the sidebar, find the **API Keys** section.
- Click **Create new secret key**
- Give your key a name
- Copy your key into `.env` and replace `YOUR_OPENAI_API_KEY` with your new API key.

From here, you'll have to manage your funds. From the sidebar, navigate to **usage**, and put some funds in your account to use our OpenAI's models to generate your own recipes and images.


#### 2. MongoDB Atlas

[Sign up to MongoDB Atlas](https://www.mongodb.com/atlas)

- Click **Create a deployment**
- Choose the cluster you'd like to use. The free version is **M0**.
- Give your cluster a name, such as **yourname_AIChefBot**.
- Copy your **Username** and **Password**, these will be used as your *administrator* values in your `.env_example` file.
- Copy your **Username** value in to the `.env` file and replace `YOUR_MONGODB_ATLAS_ADMIN_NAME`.
- Copy your **Password** value in to the `.env` file and replace `YOUR_MONGODB_ATLAS_PASSWORD`.
- Delete the **users** database, to be replaced by AIChefBot's **users** database.

#### 3. Cloudinary
[Cloudinary](https://cloudinary.com/) is the image hosting service used to store and manage recipe images generated by OpenAI's [DALL-E 2](https://openai.com/dall-e-2).
To create and manage recipe images with your own **Cloudinary Product Environment**, [create a free Cloudinary account](https://cloudinary.com/users/register_free)

- After logging in, navigate to the **Getting Started Page** either by left-click **"Getting Started"** on the console or by navigating to https://console.cloudinary.com/pm/getting-started.
- In the **Getting Started Page**, left-click the **"View Credentials"** button to open the **Product Environment Credentials** modal.
- The **Product Environment Credentials** modal shows the credentials required to connect and interact with your own Cloudinary Product Environment.
- In the **Product Environment Credentials** modal you will see the following credentials that must be copied and pasted into your `.env` file:

| .env Variable Name |  Cloudinary Product Environment Credential Name |
| --- | --- |
| **NEXT_PUBLIC_CLOUDINARY_API_KEY** | API key |
| **CLOUDINARY_API_SECRET** | API secret |
| **CLOUDINARY_CLOUD_NAME** | Cloud name |

- Copy your API key into the `.env` file, replacing `YOUR_CLOUDINARY_API_KEY`
- Copy your API secret into the `.env` file, replacing `YOUR_CLOUDINARY_API_SECRET`
- Copy your Cloud name into the `.env` file, replacing `YOUR_CLOUDINARY_CLOUD_NAME`

After these steps, you will have created your own **Cloudinary Product Environment** and added the environment variables required to connect to it.

#### 4. AWS Cognito**

You will have to create a AWS Account [Sign up to AWS](https://aws.amazon.com/console/) 
1. When you are at console home search **Cognito**
2. Click **Create user pool**

**Configure sign-in experience**
Select the options **User name, Email**

**Configure security requirements**
1. Make whatever password policy you want or you can leave it default
2. Make sure to select **No MFA** (you can add MFA but will add cost)
3. Make sure **Enable self service account recovery** is checked and use **Email only** (other options have additional cost)

**Configure sign-up experience**
1. Make sure **Enable self-registration** is selected 
2. Make sure **Keep original attribute value active when an update is pending** is selected
3. In the required attributes dropdown add **name**

**Configure message delivery**
1. Select **Send email with Cognito** keep the rest default

**Integrate your app**
1. Give your user pool a name such as `yourname-aichefbot-users`
2. Select **Use the Cognito Hosted UI** 
3. Select **Use a Cognito domain** 
4. Keep **https://** and type in a name. This will be your domain when users log in (avoid using your name here since this will be public)
5. Select **Public client** enter a App client name such as `yourname-aichefbot-app`
6. Select **Don't generate a client secret**
7. Allowed callback URLs (can edit this later) copy and paste `http://localhost:3000/api/auth/callback/cognito`
8. Click the dropdown **Advanced app client settings** scroll down to **OpenID Connect scopes** click the dropdown and add `aws.cognito.signin.user.admin` scope.
9. Click **Add sign-out URL** copy and paste `http://localhost:3000`
  
**Review and Create**
Double check all the values are correct create your user pool.

**Getting your keys**
1. Click on your newly created user pool
2. Copy the **User Pool ID** and replace `YOUR_USER_POOL_ID` inside`.env` 
3. Click the **App integration** tab
4. Copy the **Cognito domain** and replace `YOUR_COGNITO_UI_DOMAIN` inside`.env`
5. Scroll all they way down till you see **App client list**
6. On the **Client ID** tab copy the value and replace `YOUR_COGNITO_CLIENT_ID` inside`.env`

**OAuth Sign-In and Out Redirect URLS, AWS Amazon Cognito Logout Endpoint URL and AWS Amazon Cognito Issuer**

These keys are provided for you in the `.env_example` [here](./.env_example) copy them and add to `.env`.

**NextAuthJS secret**

Generate a secret with
```bash
$ openssl rand -base64 64
```
copy that value and replace `YOUR_NEXTAUTH_SECRET` inside `.env`.

### Running the Development Version

After following these steps, you will be able to run a full version of the most recent version of the application. To make changes and contribute, see the [contributing](./CONTRIBUTING.md) document.

```bash
$ npm run dev
```

<br>

Navigate to `http://localhost:3000` in your chosen browser to experience the development version.

<br>
<hr>
<br>

### Deployment

AIChefBot is hosted on [Vercel](https://vercel.com/)
The most convenient way to deploy AIChefBot on Vercel is to deploy the code from the GitHub repository which requires logging onto Vercel with your GitHub account.
Deploying your project from GitHub is useful because any changes pushed to the main branch (e.g. by Pull Request) will trigger re-deployment of the updated main branch to Vercel.
This means the Production deployment will always be up-to-date with the latest code changes.

#### Login to Vercel

- To deploy AIChefBot to Vercel, first navigate to https://vercel.com/ then left-click the **Log In** button at the top right corner of the page.
- From the Log In page, left-click the **Continue with GitHub** button.
- A browser window will open, prompting you to sign into GitHub to continue to Vercel.
- Successfully logging in to GitHub, the window will close and you will be redirected to the **Vercel Projects Overview** page.

#### Begin adding AIChefBot as a Vercel Project

- On the top right corner of the **Projects Overview Page**, left-click the **Add New** button, then left-click the **Project** button.
- This will prompt you to import a Git respository from GitHub.
- Select AIChefBot then left-click the **Import** button.
- At this point, you will be directed to the **Configure Project** page.

#### Configure Project
- You will need to enter the following information:

| Field | Value |
| --- | --- |
| Project Name | YOUR_PROJECT_NAME`*` |
| Framework Preset | Next.js |
| Root Directory | Keep Default Values |
| Build and Output Settings | Keep Default Values |
| Environment Variables | Drag and drop your local .env file to populate environment variables |

`*`: `YOUR_PROJECT_NAME` will affect the final deployment URL provisioned by Vercel.

**For example**: If you enter a `YOUR_PROJECT_NAME` (project name) value of `ai-chef-bot-test`, the final deployment URL will look something like:
`https://ai-chef-bot-test.vercel.app`.

#### Deploy Project

- After you have added the above information, left-click the **Deploy** button to deploy AIChefBot.
- Once Deployment is complete, you will see a **Congratulations!** page. From there, left-click the **Continue to Dashboard** button to go to your deployment dashboard.
- From the **Deployment Dashboard**, left-click the **Visit** button to open and access the deployed app.

#### Integrate Cognito User Pool with Deployment
After deploying AIChefBot to Vercel, you need to integrate your Cognito User Pool with your deployment.
If you do not do this, you will **not** be able to **register** or **login** to your deployment.

To integrate your User Pool with your deployment, you must update the following environment variables in both your **AWS Cognito User Pool** AND your **Vercel Deployment**:

| .env Variable Name | Updated Value |
| OAUTH_SIGN_IN_REDIRECT_URL | DEPLOYMENT_BASE_URL/api/auth/callback/cognito |
| OAUTH_SIGN_OUT_REDIRECT_URL | DEPLOYMENT_BASE_URL |

Where `DEPLOYMENT_BASE_URL` is your deployment's base URL, based on the `YOUR_PROJECT_NAME` value used during deployment.

**For example**: If you enter a `YOUR_PROJECT_NAME` (project name) value of `ai-chef-bot-test`, the final deployment URL will look something like:
`https://ai-chef-bot-test.vercel.app`.

**In this example,** you will have the following OAUTH variables:

OAUTH_SIGN_IN_REDIRECT_URL=https://ai-chef-bot-test.vercel.app/api/auth/callback/cognito

OAUTH_SIGN_OUT_REDIRECT_URL=https://ai-chef-bot-test.vercel.app

**WARNING:** If you do not add these environment variables to both your **AWS Cognito User Pool** AND your **Vercel Deployment** you will **NOT** able to login or create an account on your deployment.

##### Add Allowed Callback and Allowed Sign-Out URLs (AWS Cognito User Pool)

- First, navigate to your AWS Cognito User Pool.
- Navigate to **App integration** tab, scroll down till you find **App client list**.
- click your app name, scroll down to **Hosted UI** click edit.
- in the **Allowed callback URLs** section click Add another URL refer to step 7 right below.
- After go to the **Allowed sign-out URLs** section click Add another URL refer to step 9 right below. 
- Refer to **Steps 7 to 9** of [AWS Cognito - Integrate Your App](#integrate-your-app):
  - Step 7: Add the following as an **Allowed Callback URL**:
  
  `DEPLOYMENT_BASE_URL/api/auth/callback/cognito`
  
  (e.g. https://ai-chef-bot-test.vercel.app/api/auth/callback/cognito)
  - Step 9: Add the following as a **Sign-Out URL**:
  
  `DEPLOYMENT_BASE_URL`
  
  (e.g. https://ai-chef-bot-test.vercel.app)

##### Add new Allowed Callback and Allowed Sign-Out URLs to Vercel Deployment Environment Variables

You must add these values to your deployment's Environment Variables:
- From your deployed project's **Deployment Dashboard**, left-click the **Settings** button.
- On the **Project Settings** page, left-click the **Environment Variables** button to access the **Environment Variables** page
- On the **Environment Variables** section, copy and paste the following values to add these environment variables:

| Key Name | Value |
| --- | --- |
| OAUTH_SIGN_IN_REDIRECT_URL | DEPLOYMENT_BASE_URL/api/auth/callback/cognito (e.g. https://ai-chef-bot-test.vercel.app/api/auth/callback/cognito) |
| OAUTH_SIGN_OUT_REDIRECT_URL | DEPLOYMENT_BASE_URL (e.g. https://ai-chef-bot-test.vercel.app) |

- Left-click the **Save** button to save these environment variables.

##### Redeploy Project
After saving the new environment variables, you must **redeploy** your deployment so the production build will have these environment variables:
- On the same page, left-click the **Project** button to go to the **Production Deployment** page
- Then left-click the **Build Logs** button.
- Beside the Visit button, left-click the **vertical ellipsis** button (three `.`'s on top of each other), **then left-click Redeploy**
- Left-click **Redeploy** to confirm redeployment.

#### Start Generating Recipes

After redeployment is complete, user authentication via AWS Cognito will be restored to your production deployment.

You can now navigate to your deployment and interact with it as it was meant to be.
